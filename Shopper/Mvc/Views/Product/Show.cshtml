@using IdentityServer4.Extensions
@using Shopper.Extensions.Helpers
@model Product;
@{
    Layout = "_Layout";
    var product = @Model;
    var imagesViewModel = new ImagesUploadModel
    {
        CurrentImageName = product.ImagePath,
        ImagesCount = (short) (4 - product.Images.Count)
    };

    ViewData["TotalSales"] = product.Skus.Sum(sku => sku.Sales.Any() ? sku.Sales.Where(s => s.IsConfirmed).Sum(sale => sale.Price * sale.Quantity) : 0).ToString("N0");
    ViewData["TotalStockValue"] = product.Skus.Sum(s => s.BuyingPrice * s.Quantity).ToString("N0");
}

@section css
{
    <style type="text/css">
        .product-image-wrapper, .product-image-thumb {
          position: relative;
        ...
        }
        .product-image-wrapper #edit-button,
        .product-image-wrapper #delete-button {
          visibility: hidden;
        }
        .product-image-wrapper:hover #edit-button,
        .product-image-wrapper:hover #delete-button {
          visibility: visible;
        }
        .close-button {
          position: absolute;
          top: 2px;
          right: 2px;
          z-index: 100;
        ...
        }
        .edit-button {
                  position: absolute;
                  top: 2px;
                  right: 25px;
                  z-index: 100;
                ...
                }

        fieldset
        	{
        		border: 1px solid #ddd !important;
        		margin: 0;
        		xmin-width: 0;
        		padding: 10px;
        		position: relative;
        		border-radius:4px;
        		/*background-color:#f5f5f5;*/
        		padding-left:10px!important;
        	}

        		legend
        		{
        			font-size:14px;
        			font-weight:bold;
        			margin-bottom: 0px;
        			width: 35%;
        			border: 1px solid #ddd;
        			border-radius: 4px;
        			padding: 5px 5px 5px 10px;
        			/*background-color: #ffffff;*/
        		}
      </style>
}

<div class="card card-solid">
    <div class="card-body">
        <div class="row">
            <div class="col-12 col-sm-6">
                <div class="col-12 product-image-wrapper">
                    @if (!product.ImagePath.IsNullOrEmpty() || product.Images.Any())
                    {
                        if (!product.ImagePath.IsNullOrEmpty())
                        {
                            <th:a class="product-image-delete-link btn-delete" id="delete-button" asp-controller="Product" asp-action="DeleteMainImage" asp-route-id="@product.Id" style="color: red">
                                <i class="fas fa-times-circle close-button"></i>
                            </th:a>
                            <i class="fas fa-edit edit-button" id="edit-button" onclick="openImageEditModal('@Url.Action("UpdateMainImage", "Product", new {id = product.Id})')"></i>
                            <th:img asp-append-version="true" src="@product.ImagePath.LoadProductImage(ViewContext.HttpContext)" class="product-image" alt="Product Image"/>
                        }
                        else if (product.Images.Any())
                        {
                            var image = product.Images.First();
                            <th:a class="product-image-delete-link btn-delete" id="delete-button" asp-controller="Product" asp-action="DeleteOtherImage" asp-route-id="@image.Id" style="color: red">
                                <i class="fas fa-times-circle close-button"></i>
                            </th:a>
                            <i class="fas fa-edit edit-button" id="edit-button" onclick="openImageEditModal('@Url.Action("UpdateOtherImage", "Product", new {id = image.Id})')"></i>
                            <th:img asp-append-version="true" src="@image.ImagePath.LoadProductImage(ViewContext.HttpContext)" class="product-image" alt="Product Image"/>
                        }
                    }
                    else
                    {
                        <th:img asp-append-version="true" src="/images/no-image-2.jpg" class="product-image" alt="Upload product images"/>
                    }
                </div>
            </div>
            <div class="col-12 col-sm-6">
                <h3 class="my-3">@product.Name</h3>
                @if (product.Skus.Any() && product.Attributes.Any())
                {
                    <hr>
                    <h4>
                        Available Options
                        <small>[@string.Join(", ", product.Attributes.Select(att => att.Attribute.Name))]</small>
                    </h4>
                    <div class="btn-group btn-group-toggle">
                        @foreach (var skuAtt in product
                            .Skus
                            .Select(sku => string.Join(" - ", sku.SkuAttributes.Select(skuAtt => skuAtt.Option.Name))).ToList().Distinct())
                        {
                            <label class="btn btn-default text-center active">
                                @skuAtt
                            </label>
                        }
                    </div>
                }
                <ul class="list-group list-group-unbordered mb-3 col-6">
                    <li class="list-group-item">
                        <b>Group</b> <a class="float-right">@product.ProductType.ProductCategory.ProductGroup.Name</a>
                    </li>
                    <li class="list-group-item">
                        <b>Category</b> <a class="float-right">@product.ProductType.ProductCategory.Name</a>
                    </li>
                    <li class="list-group-item">
                        <b>Type</b> <a class="float-right">@product.ProductType.Name</a>
                    </li>
                </ul>
                <h4>Product images</h4>
                <div class="col-12 product-image-thumbs">
                    @if (!product.ImagePath.IsNullOrEmpty())
                    {
                        <th:partial name="_ProductMainImage"></th:partial>
                    }
                    @foreach (var image in product.Images)
                    {
                        <th:partial name="_ProductOtherImage" model="image"></th:partial>
                    }
                    @if (product.Images.Count < 4 || product.ImagePath.IsNullOrEmpty())
                    {
                        <a href="" data-toggle="modal" data-target="#add-product-images" title="Add Product Images">
                            <i style="padding-top: 20px" class="fas fa-plus fa-3x"></i>
                        </a>
                    }
                </div>
            </div>
        </div>
        <hr><br>
        <!-- Info boxes -->
        <div class="row">
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box">
                    <span class="info-box-icon bg-info elevation-1">
                        <i class="fas fa-warehouse"></i>
                    </span>

                    <div class="info-box-content">
                        <span class="info-box-text">Total stock units</span>
                        <h5 class="info-box-number">
                            @product.Skus.Sum(s => s.Quantity)
                        </h5>
                    </div>
                    <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
            </div>
            <!-- /.col -->
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-danger elevation-1">
                        <i class="fas fa-dolly-flatbed"></i>
                    </span>

                    <div class="info-box-content">
                        <span class="info-box-text">In stock</span>
                        <h5 class="info-box-number">@product.Skus.Where(s => s.RemainingQuantity > 0).Sum(s => s.RemainingQuantity)</h5>
                    </div>
                    <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
            </div>
            <!-- /.col -->

            <!-- fix for small devices only -->
            <div class="clearfix hidden-md-up"></div>

            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-success elevation-1">
                        <i class="fas fa-coins"></i>
                    </span>

                    <div class="info-box-content">
                        <span class="info-box-text">Total stock value</span>
                        <h5 class="info-box-number">@ViewData["TotalStockValue"]/-</h5>
                    </div>
                    <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
            </div>
            <!-- /.col -->
            <div class="col-12 col-sm-6 col-md-3">
                <div class="info-box mb-3">
                    <span class="info-box-icon bg-warning elevation-1">
                        <i class="fas fa-piggy-bank"></i>
                    </span>

                    <div class="info-box-content">
                        <span class="info-box-text">Total sales</span>
                        <h5 class="info-box-number">@ViewData["TotalSales"]/-</h5>
                    </div>
                    <!-- /.info-box-content -->
                </div>
                <!-- /.info-box -->
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->
        <div class="row mt-4">
            <nav class="w-100">
                <div class="nav nav-tabs" id="product-tab" role="tablist">
                    <a class="nav-item nav-link active" id="stock-tab" data-toggle="tab" href="#stock" role="tab" aria-controls="stock" aria-selected="true">Stock History</a>
                    <a class="nav-item nav-link" id="sales-tab" data-toggle="tab" href="#sales" role="tab" aria-controls="sales" aria-selected="false">Sales History</a>
                    @* <a class="nav-item nav-link" id="product-rating-tab" data-toggle="tab" href="#product-rating" role="tab" aria-controls="product-rating" aria-selected="false">Rating</a> *@
                </div>
            </nav>
            <div class="tab-content p-3" id="nav-tabContent">
                <div class="tab-pane fade show active" id="stock" role="tabpanel" aria-labelledby="stock-tab">
                    <div class="row">
                        <div class="col-md-12">
                            <th:partial name="_ProductSkus"/>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
                    <div class="row">
                        <div class="col-md-12">
                            <th:partial name="_ProductSales"/>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /.card-body -->
</div>
<!-- /.card -->

<div class="modal fade" id="add-product-images">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                @if (product.ImagePath.IsNullOrEmpty())
                {
                    <h4 class="modal-title">Add Product Main Photo</h4>
                }
                else
                {
                    <h4 class="modal-title">Add Other Product Photo</h4>
                }
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <th:form enctype="multipart/form-data" id="product-photo-form" asp-controller="Product" asp-action="AddImages" asp-route-id="@product.Id" method="post">
                    <th:partial name="_AddProductImageForm" model="imagesViewModel"/>
                </th:form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="edit-image-modal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="edit-image-title">Edit Image</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <th:form enctype="multipart/form-data" href="#" id="edit-image-action" method="post">
                    <th:partial name="_UpdateImageForm" model="new UpdateImageModel()"/>
                </th:form>
            </div>
        </div>
    </div>
</div>

@section scripts
{
    <th:script src="~/js/show-product.js"></th:script>
    <!-- dropzonejs -->
    <th:script src="~/plugins/bs-custom-file-input/bs-custom-file-input.min.js"></th:script>
    <script >
      useDeleteConfirmation();
        $(function () {
                  bsCustomFileInput.init();
                });
    </script>

    <th:partial name="_ValidationScriptsPartial"></th:partial>
    <th:partial name="Partials/_ToastScript"></th:partial>
}
